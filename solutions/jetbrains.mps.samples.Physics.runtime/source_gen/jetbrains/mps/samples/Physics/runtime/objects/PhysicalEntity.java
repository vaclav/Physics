package jetbrains.mps.samples.Physics.runtime.objects;

/*Generated by MPS */

import jetbrains.mps.samples.Physics.runtime.vectors.VectorLike;
import org.ode4j.ode.DBody;
import jetbrains.mps.samples.Physics.runtime.objects.rendering.Fixture;
import java.math.BigDecimal;
import java.util.ArrayList;
import jetbrains.mps.samples.Physics.runtime.objects.forces.Force;
import org.ode4j.ode.OdeHelper;
import processing.core.PApplet;
import org.ode4j.math.DVector3C;
import java.util.List;
import jetbrains.mps.samples.Physics.runtime.vectors.BigDecimalHelper;
import jetbrains.mps.samples.Physics.runtime.vectors.InternalVector;

public class PhysicalEntity<T extends SystemScope> extends VectorLike implements EntityLike {
  private DBody body;
  private World world;
  private Fixture fixture;

  private BigDecimal massCached;

  /**
   * Forces applied on the entity
   */
  private ArrayList<Force> forces = new ArrayList();
  public PhysicalEntity(World world) {
    this.world = world;
    // Creating body 
    body = OdeHelper.createBody(world.getWorld());
  }
  public void applyForces() {
    for (Force force : forces) {
      body.addForce(force.getForce(world, this));
    }
  }
  public void render(PApplet ctx) {
    DVector3C position = body.getPosition();
    ctx.pushMatrix();
    ctx.translate((float) position.get0(), (float) position.get1(), (float) position.get2());
    fixture.render(ctx);
    ctx.popMatrix();
  }
  public void setFixture(Fixture fixture) {
    this.fixture = fixture;
  }
  public DBody getBody() {
    return body;
  }
  public List<Force> getForces() {
    return forces;
  }

  public void setMass(Number value) {
    massCached = BigDecimalHelper.of(value);
  }

  /**
   * Create mass representation internally
   */
  public void bindFixture() {
    // Creating mass representation 
    fixture.bindToBody(body, massCached.doubleValue());
  }

  @Override
  public BigDecimal getX() {
    return BigDecimal.valueOf(this.getBody().getPosition().get0());
  }
  @Override
  public BigDecimal getY() {
    return BigDecimal.valueOf(this.getBody().getPosition().get1());
  }
  @Override
  public BigDecimal getZ() {
    return BigDecimal.valueOf(this.getBody().getPosition().get2());
  }

  public BigDecimal getMass() {
    if (massCached == null) {
      massCached = BigDecimal.valueOf(body.getMass().getMass());
    }
    return massCached;
  }

  public VectorLike getPosition() {
    return InternalVector.fromDVector3C(getBody().getPosition());
  }

  public VectorLike getVelocity() {
    return InternalVector.fromDVector3C(getBody().getLinearVel());
  }

  public void init(T scope, World world) {
  }
}
